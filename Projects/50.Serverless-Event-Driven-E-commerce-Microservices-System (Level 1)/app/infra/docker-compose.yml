services:
  consul:
    image: hashicorp/consul:1.17
    container_name: consul
    ports:
      - "8500:8500"
    command: "agent -dev -client=0.0.0.0"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 10s
      timeout: 5s
      retries: 5    
    networks:
      - microservices-net

  # ==============================
  # üêò POSTGRES DATABASE
  # ==============================
  postgres:
    image: postgres:15
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ../data/pg:/var/lib/postgresql/data
      - ../scripts:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - microservices-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5      

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@local.dev
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../data/pgadmin:/var/lib/pgadmin        
    networks:
      - microservices-net


  nginx:
    image: nginx:latest
    container_name: api-gateway
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      #- ./swagger-ui:/usr/share/nginx/html
    ports:
      - "8080:8080"
    depends_on:
      - post-service
      - user-service    
    networks:
      - microservices-net

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6370:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ../data/redis:/data_redis   
    networks:
      - microservices-net

  swagger-service:
    build:
      context: ../services
      dockerfile: swagger-service/Dockerfile
    container_name: swagger-service
    ports:
      - "8088:8080"
    environment:
    - GITHUB_TOKEN=${GITHUB_TOKEN}

    volumes:
      - ../services/swagger-service/src:/app/swagger-service/src

    depends_on:
      - user-service
      - post-service
    networks:
      - microservices-net

  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566"
      #- "4571:4571"
    environment:
      - SERVICES=s3,ec2,servicediscovery,apigateway,apigatewayv2,iam,lambda,rds,dynamodb,sqs,sns,apigateway,cloudformation,cloudwatch,sts
      - DEBUG=1
      - DEFAULT_REGION=us-east-2
      #- AWS_DEFAULT_REGION=us-east-2
      #- LS_S3_DISABLE_REGION_CHECK=1
      - LOCALSTACK_PERSISTENCE=0
      - DATA_DIR=/data
    volumes:
      #- "/var/run/docker.sock:/var/run/docker.sock"
      - ../data/localstack:/data

  # ==============================
  # üì∞ USER SERVICE
  # ==============================
  user-service:
    build:
      context: ../services/user-service
      dockerfile: Dockerfile
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}      
    container_name: user-service
    restart: always
    ports:
      - "3002:3002"
    env_file: ../services/user-service/.env      
    command: npm run dev      
    volumes:
      - ../services/user-service/src:/app/user-service/src
      - ../services/shared-lib:/app/node_modules/@tqnhu4/shared-lib #Test on local before publish

    depends_on:
      postgres:
        condition: service_healthy
      #user-service:
      #  condition: service_started
      consul:
        condition: service_healthy

    networks:
      - microservices-net

  # ==============================
  # üì∞ POST SERVICE
  # ==============================
  post-service:
    build:
      context: ../services/post-service
      dockerfile: Dockerfile
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}      
    container_name: post-service
    restart: always
    ports:
      - "3003:3003"

    env_file: ../services/post-service/.env
    command: npm run dev      
    volumes:
      - ../services/post-service/src:/app/post-service/src
      - ../services/shared-lib:/app/node_modules/@tqnhu4/shared-lib #Test on local before publish

    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_started
      consul:
        condition: service_healthy

    networks:
      - microservices-net


  loki:
    image: grafana/loki:2.9.0
    ports:
      - "3100:3100"
    networks:
      - microservices-net      

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    networks:
      - microservices-net      

  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - microservices-net


# ==============================
# üß© VOLUMES & NETWORK
# ==============================
volumes:
  pgdata:

networks:
  microservices-net:
    driver: bridge
